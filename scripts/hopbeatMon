#!/usr/bin/python3
###
### Author: rdt12@psu.edu
### Date: Sep 3, 2020
### Desc: In a loop, connect to the HOP server and write metrics to the influx server.
###       Metrics include:
###
###           time to run kafkacat
###           hearbeats since last loop
###           difference between hearbeat timestamp and now
###
from optparse import OptionParser
import Utils as ut
import HeartUtils as hu
import sys
import os
import time
from hop import Stream
import json

## Line buffer stdout and stderr
sys.stdout = os.fdopen(sys.stdout.fileno(), 'w', buffering=1)
sys.stderr = os.fdopen(sys.stderr.fileno(), 'w', buffering=1)

##
## Parse options.
##
cHelp     = "SCiMMA client configuration file"
sHelp     = "SCiMMA server URL"
sUrl      = "dev.hop.scimma.org:9092"
iUrl      = "http://influx.dev.hop.scimma.org:8010"
topic     = "heartbeat"
influxDb  = "hop"
interval  = "30"

p = OptionParser(usage="Usage: %prog [options]")
p.add_option("",   "--scimma", dest="scimmaUrl", default=sUrl, help=sHelp)
p.add_option("-F", "--config", dest="scimmaConfFile", default="~/shared/kafkacat.conf", help=cHelp)
(o, a) = p.parse_args()

if (os.environ.get('INFLUX_URL') is not None):
    iUrl = os.environ.get('INFLUX_URL')

if (os.environ.get('INFLUX_DB') is not None):
    influxDb = os.environ.get('INFLUX_DB')

if (os.environ.get('ICINGA_URL') is not None):
    icingaUrl = os.environ.get('ICINGA_URL')

if (os.environ.get('ICINGA_SERVICE') is not None):
    icingaService = os.environ.get('ICINGA_SERVICE')

if (os.environ.get('HOP_TOPIC') is not None):
   topic = os.environ.get('HOP_TOPIC')

if (os.environ.get('MONITOR_INTERVAL') is not None):
    interval = os.environ.get('MONITOR_INTERVAL')

scimmaUrl      = o.scimmaUrl
scimmaConfFile = os.path.expanduser(o.scimmaConfFile)
influxUrl      = iUrl

print("hopBeatMon starting")
print("SCiMMA server URL:  %s" % scimmaUrl)
print("Hopbeat topic:      %s" % topic)
print("Interval:           %s" % interval)
print("Iinflux URL:        %s" % influxUrl)
print("Influx DB:          %s" % influxDb)
print("SCiMMA config file: %s\n" % scimmaConfFile)

lastBeat = 0
stream = Stream(persist=True)
with stream.open(scimmaUrl) as s:
  for message in s:
    ok       = 1
    nowFloat = time.time()
    now      = int(nowFloat * 10**9)
    nowMs    = int(nowFloat * 10**6)
    beatTime = message["timestamp"]
    beat     = message["count"]
    if (lastBeat > 0):
      latency  = (nowMs - beatTime)/(10**6)
      beatDiff = beat - lastBeat
      hu.writeStats(influxUrl, influxDb, ok, now, latency, beatDiff)
      hu.writeCheck(influxUrl, influxDb, ok, now, latency, beatDiff)
    lastBeat = beat
hu.writeStats(influxUrl, influxDb, 0, now, latency, beatDiff)
hu.writeCheck(influxUrl, influxDb, ok, now, latency, beatDiff)
exit(0)
